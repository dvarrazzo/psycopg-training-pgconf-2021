<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title><em>psycopg</em>: Python for PostgreSQL</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
      
      <link rel="stylesheet" href="css/psycopg.css">
      
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-1">
          <div class="inner">
            
            <header><h1><em>psycopg</em>: Python for PostgreSQL</h1></header>
            
            
            <section><img alt="img/psycopg.png" src="img/psycopg.png" />
<p class="text-right">PGConf.Online 2021, <tt class="docutils literal"><span class="pre">'[2021-03-01,2021-03-04)'::daterange</span></tt></p>
<p class="text-right">Daniele Varrazzo</p>
<!-- Note to piro: you want
:autocmd BufWritePost psycopg.rst :silent !make html --></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              1/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>What is <tt class="docutils literal">psycopg2</tt>?</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>‚öôÔ∏è industry standard Python-PostgreSQL adapter</li>
<li>üí™ libpq based</li>
<li>‚öñÔ∏è 50% C, 50% Python</li>
<li>(üêç+üá®)+üêò=‚ù§Ô∏è</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              2/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>Have your virtualenv!</h1></header>
            
            
            <section><pre><span></span>$ python3 -m venv env
$ <span class="nb">source</span> env/bin/activate
<span class="o">(</span>env<span class="o">)</span> $
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              3/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>Basic usage: import</h1></header>
            
            
            <section><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              4/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-5">
          <div class="inner">
            
            <header><h1>Zoom: installation</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li><tt class="docutils literal">pip install psycopg2</tt><ul>
<li>if you have C compiler and client libraries</li>
</ul>
</li>
<li><tt class="docutils literal">pip install <span class="pre">psycopg2-binary</span></tt><ul>
<li>on supported platforms (no Alpine Docker image)</li>
</ul>
</li>
<li>They both install a <tt class="docutils literal">psycopg2</tt> package<ul>
<li><tt class="docutils literal">import psycopg2</tt> from Python</li>
</ul>
</li>
<li>They cannot coexist, so writing <tt class="docutils literal">requirements.txt</tt> is problematic<ul>
<li>You should depend on <tt class="docutils literal">psycopg2</tt></li>
<li>You can use <tt class="docutils literal"><span class="pre">psycopg2-binary</span></tt> for interactive hacking</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              5/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-6">
          <div class="inner">
            
            <header><h1>Installation for <tt class="docutils literal">psycopg3</tt></h1></header>
            
            
            <section><p class="font-bigger"><strong>Not yet on PyPI</strong> but this is the plan:</p>
<ul class="font-bigger simple">
<li><tt class="docutils literal">pip install psycopg3</tt><ul>
<li>pure Python (requires client libraries)</li>
</ul>
</li>
<li><tt class="docutils literal">pip install psycopg3[c]</tt>:<ul>
<li>Faster (requires client libraries and C compiler)</li>
</ul>
</li>
<li><tt class="docutils literal">pip install psycopg3[binary]</tt>:<ul>
<li>Faster, no dependency, on supported platforms</li>
</ul>
</li>
<li>You can have projects specifying <tt class="docutils literal">psycopg3</tt> only, and use the &quot;speedup
extra&quot; you may need.</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              6/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-7">
          <div class="inner">
            
            <header><h1>Basic usage: connection</h1></header>
            
            
            <section><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro&quot;</span><span class="p">)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              7/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-8">
          <div class="inner">
            
            <header><h1>Zoom in: connection</h1></header>
            
            
            <section><ul class="simple">
<li>You can connect with keywords or with a connection string</li>
</ul>
<pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro user=piro host=somewhere&quot;</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="s2">&quot;piro&quot;</span> <span class="n">user</span><span class="o">=</span><span class="s2">&quot;piro&quot;</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;somewhere&quot;</span><span class="p">)</span>
</pre>
<ul class="simple">
<li><strong>Tip:</strong> don't bother with keywords: have the connection string in the settings</li>
<li>Why? Because you can use the same with <tt class="docutils literal">psql</tt> (and <tt class="docutils literal">pg_dump</tt>, etc.)</li>
</ul>
<pre><span></span>psql <span class="s2">&quot;dbname=piro user=piro host=somewhere&quot;</span>
</pre>
<ul class="simple">
<li>Easier to configure (can use a single env var)</li>
<li>If you need to access the single parts you can use
<tt class="docutils literal">psycopg2.extensions.parse_dsn()</tt></li>
<li><strong>Note:</strong> you can also use <tt class="docutils literal">PG*</tt> <a class="reference external" href="https://www.postgresql.org/docs/current/libpq-envars.html">env vars</a> (<tt class="docutils literal">PGDATABASE</tt>,
<tt class="docutils literal">PGUSER</tt>...)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              8/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-9">
          <div class="inner">
            
            <header><h1>Basic usage: cursor</h1></header>
            
            
            <section><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro&quot;</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              9/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-10">
          <div class="inner">
            
            <header><h1>cursor? ü§î</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              10/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-11">
          <div class="inner">
            
            <header><h1>No such a thing in psql...</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>DBAPI design:<ul>
<li>connections manage sessions and transactions</li>
<li>cursors manage queries and results</li>
<li>inspired to server-side cursors, but normally in psycopg2 the state is
on the client...</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              11/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-12">
          <div class="inner">
            
            <header><h1>Basic usage: execute</h1></header>
            
            
            <section><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro&quot;</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from generate_series(1, 10)&quot;</span><span class="p">)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              12/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-13">
          <div class="inner">
            
            <header><h1>Adaptation</h1></header>
            
            
            <section><img alt="img/py-to-pg.png" src="img/py-to-pg.png" />
<ul class="font-bigger simple">
<li>Using Python variables in an SQL query</li>
</ul>
<pre><span></span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>    <span class="c1"># query, with placeholders</span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>           <span class="c1"># sequence of params</span>

<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select </span><span class="si">%(a)s</span><span class="s2">, </span><span class="si">%(b)s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># query, with named placeholders</span>
    <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>     <span class="c1"># mapping of params</span>
</pre>
<ul class="font-bigger simple">
<li>Any possible query (psycopg doesn't do any parsing)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              13/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-14">
          <div class="inner">
            
            <header><h1>Adaptation</h1></header>
            
            
            <section><img alt="img/py-to-pg.png" src="img/py-to-pg.png" />
<ul class="font-bigger simple">
<li><strong>DANGER!</strong> Don't do this!</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(&#39;ab&#39;,)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="s1">&#39; Books&#39;</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;ipython-input-29-720a7746fc83&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="s1">&#39; Books&#39;</span><span class="p">))</span>
<span class="gr">ProgrammingError</span>: <span class="n">syntax error at or near &quot;&#39; || &#39;&quot;</span>
<span class="go">LINE 1: select &#39;O&#39;Reilly&#39; || &#39; Books&#39;</span>
</pre>
<ul class="font-bigger simple">
<li>Don't use string concatenation, string formatting</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              14/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-15">
          <div class="inner">
            
            <header><h1>Adaptation</h1></header>
            
            
            <section><img alt="img/py-to-pg.png" src="img/py-to-pg.png" />
<ul class="font-bigger simple">
<li>The wrong way üëé</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">))</span>
</pre>
<ul class="font-bigger simple">
<li>The right way üëç<ul>
<li>No quotes around placeholders</li>
<li>No use of <tt class="docutils literal">%</tt> or <tt class="docutils literal">+</tt> string operators</li>
</ul>
</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select </span><span class="si">%s</span><span class="s2"> || </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">))</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              15/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-16">
          <div class="inner">
            
            <header><h1>Adaptation</h1></header>
            
            
            <section><ul class="simple">
<li>Mandatory reference</li>
</ul>
<img alt="img/exploits_of_a_mom.png" src="img/exploits_of_a_mom.png" />
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO students (name) VALUES (&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre>
<ul class="simple">
<li>Would become:</li>
</ul>
<pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">students</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;Robert&#39;</span><span class="p">);</span> <span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">students</span><span class="p">;</span> <span class="c1">--&#39;)</span>
</pre>
<ul class="simple">
<li>Funny, but wrong conclusion: <em>do not sanitise inputs, let the driver do it!</em></li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into students (name) values (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              16/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-17">
          <div class="inner">
            
            <header><h1>Adaptation: only for values</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>It doesn't work if you have tables/fields names in variables</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;insert into </span><span class="si">%s</span><span class="s2"> values (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="p">,</span>
<span class="gp">... </span>    <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
<span class="go">SyntaxError: syntax error at or near &quot;&#39;table_name&#39;&quot;</span>
<span class="go">LINE 1: insert into &#39;table_name&#39; values (10, 20)</span>
<span class="go">                    ^</span>
</pre>
<ul class="font-bigger simple">
<li>You can use the <tt class="docutils literal">psycopg2.sql</tt> module to compose queries dynamically</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">sql</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;insert into {} values (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
<span class="go">UndefinedTable: relation &quot;table_name&quot; does not exist</span>
<span class="go">LINE 1: insert into &quot;table_name&quot; values (10, 20)</span>
<span class="go">                    ^</span>
</pre>
<ul class="font-bigger simple">
<li>That's a better error üòÖ</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              17/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-18">
          <div class="inner">
            
            <header><h1>Data type mapping</h1></header>
            
            
            <section><p>Default data types mapping: no surprise here</p>
<table border="1" class="data-types docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Python</th>
<th class="head">PostgreSQL</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">None</tt></td>
<td><tt class="docutils literal">NULL</tt></td>
</tr>
<tr><td><tt class="docutils literal">bool</tt></td>
<td><tt class="docutils literal">bool</tt></td>
</tr>
<tr><td><tt class="docutils literal">int</tt></td>
<td><tt class="docutils literal">smallint</tt>,
<tt class="docutils literal">integer</tt>,
<tt class="docutils literal">bigint</tt></td>
</tr>
<tr><td><tt class="docutils literal">float</tt></td>
<td><tt class="docutils literal">real</tt>,
<tt class="docutils literal">double</tt></td>
</tr>
<tr><td><tt class="docutils literal">Decimal</tt></td>
<td><tt class="docutils literal">numeric</tt></td>
</tr>
<tr><td><tt class="docutils literal">str</tt></td>
<td><tt class="docutils literal">varchar</tt>,
<tt class="docutils literal">text</tt></td>
</tr>
<tr><td><tt class="docutils literal">date</tt></td>
<td><tt class="docutils literal">date</tt></td>
</tr>
<tr><td><tt class="docutils literal">time</tt></td>
<td><tt class="docutils literal">time</tt></td>
</tr>
<tr><td><tt class="docutils literal">datetime</tt></td>
<td><tt class="docutils literal">timestamp</tt>,
<tt class="docutils literal">timestamptz</tt></td>
</tr>
<tr><td><tt class="docutils literal">timedelta</tt></td>
<td><tt class="docutils literal">interval</tt></td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              18/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-19">
          <div class="inner">
            
            <header><h1>More Data!</h1></header>
            
            
            <section><ul class="simple">
<li><tt class="docutils literal">list</tt> &lt;-&gt; <tt class="docutils literal">ARRAY</tt></li>
</ul>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select array_agg(d)::date[]</span>
<span class="s2">    from generate_series(&#39;2013-07-11&#39;::date, &#39;2013-07-12&#39;::date,</span>
<span class="s2">        &#39;1 day&#39;::interval) s(d)&quot;&quot;&quot;</span><span class="p">)</span>
<span class="c1"># [datetime.date(2013, 7, 11), datetime.date(2013, 7, 12)]</span>
</pre>
<ul class="simple">
<li>[<tt class="docutils literal">named</tt>] <tt class="docutils literal">tuple</tt> &lt;-&gt; composite</li>
</ul>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TYPE card AS (value int, suit text)&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">register_composite</span><span class="p">(</span><span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select (8, &#39;hearts&#39;)::card&quot;</span><span class="p">)</span>
<span class="c1"># card(value=8, suit=&#39;hearts&#39;)</span>
</pre>
<ul class="simple">
<li>Psycopg <tt class="docutils literal">Range</tt> object &lt;-&gt; <tt class="docutils literal">range</tt></li>
</ul>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;[0,10)&#39;::int8range&quot;</span><span class="p">)</span>
<span class="c1"># NumericRange(0, 10, &#39;[)&#39;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">upper_inc</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lower_inc</span>
<span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              19/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-20">
          <div class="inner">
            
            <header><h1>Mythical JSON(B)!</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>Anything‚Ñ¢ &lt;-&gt; <tt class="docutils literal">json</tt>, <tt class="docutils literal">jsonb</tt></li>
<li>Need to use a <tt class="docutils literal">Json()</tt> wrapper to mark you want JSON dumping</li>
</ul>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into mytable (jsondata) values (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">Json</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})])</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              20/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-21">
          <div class="inner">
            
            <header><h1>Basic usage: fetching results</h1></header>
            
            
            <section><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro&quot;</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from generate_series(1, 10)&quot;</span><span class="p">)</span>

<span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

<span class="n">cur</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[(</span><span class="mi">2</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)]</span>

<span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="p">[(</span><span class="mi">5</span><span class="p">,),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)]</span>

<span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              21/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-22">
          <div class="inner">
            
            <header><h1>Basic usage: iterating on results</h1></header>
            
            
            <section><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro&quot;</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from generate_series(1, 10)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">7</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">8</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">9</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">10</span><span class="p">,)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              22/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-23">
          <div class="inner">
            
            <header><h1>Waiting for <tt class="docutils literal">psycopg3</tt>: <tt class="docutils literal">conn.execute()</tt></h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>A more familar pattern</li>
</ul>
<pre><span></span><span class="k">with</span> <span class="n">psycopg3</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre>
<ul class="font-bigger simple">
<li>Not really a new object: it's still a cursor</li>
<li>Just pretend the <tt class="docutils literal">fetch()</tt> methods are not there üòâ</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              23/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-24">
          <div class="inner">
            
            <header><h1>Other types of records</h1></header>
            
            
            <section><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">extras</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span> <span class="o">=</span> <span class="n">cnn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">extras</span><span class="o">.</span><span class="n">NamedTupleCursor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;select 10 as a, &#39;hello&#39; as b, &#39;2020-02-01&#39;::date as d&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">Record(a=10, b=&#39;hello&#39;, d=datetime.date(2020, 2, 1))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span> <span class="o">=</span> <span class="n">cnn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">extras</span><span class="o">.</span><span class="n">RealDictCursor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;select 10 as a, &#39;hello&#39; as b, &#39;2020-02-01&#39;::date as d&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">{&#39;a&#39;: 10, &#39;b&#39;: &#39;hello&#39;, &#39;d&#39;: datetime.date(2020, 2, 1)}</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              24/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-25">
          <div class="inner">
            
            <header><h1>Server and Client Cursors</h1></header>
            
            
            <section><pre><span></span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from my_million_rows_table&quot;</span><span class="p">)</span>
<span class="c1"># you get 1M rows on the client</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</pre>
<p class="font-bigger">The result is transferred completely to the client</p>
<pre><span></span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="s2">&quot;my-cursor&quot;</span><span class="p">)</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from my_million_rows_table&quot;</span><span class="p">)</span>
<span class="c1"># runs DECLARE &quot;my-cursor&quot; CURSOR FOR select * ...</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="c1"># you get one row</span>
</pre>
<p class="font-bigger">Only the rows needed are transferred to the client</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              25/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-26">
          <div class="inner">
            
            <header><h1>Running queries: auto-transaction</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li><tt class="docutils literal">psycopg2</tt> starts a transaction at every new statement.</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:45:10.919226+00:00</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:45:10.919226+00:00</span>

<span class="go"># same time! we are in a transaction</span>
</pre>
<ul class="font-bigger simple">
<li>Don't leave connections idle in transaction!</li>
</ul>
<pre class="literal-block">
piro=# select pid, state from pg_stat_activity
piro-# where state is not null;
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   pid   ‚îÇ        state        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  965924 ‚îÇ idle                ‚îÇ
‚îÇ 1486322 ‚îÇ idle in transaction ‚îÇ
‚îÇ 1486371 ‚îÇ active              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              26/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-27">
          <div class="inner">
            
            <header><h1>Remember to close your transactions!</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>You can use <tt class="docutils literal">with</tt> on the connection to represent a transaction</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:55:25.717751+00:00</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:55:27.385814+00:00</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              27/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-28">
          <div class="inner">
            
            <header><h1>Autocommit mode</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li>...or you can go without transactions</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">autocommt</span> <span class="o">=</span> <span class="bp">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:55:25.717751+00:00</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:55:27.385814+00:00</span>
</pre>
<ul class="font-bigger simple">
<li>Necessary for certain statements<ul>
<li><tt class="docutils literal">CREATE DATABASE</tt></li>
<li><tt class="docutils literal">CREATE INDEX CONCURRENTLY</tt></li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              28/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-29">
          <div class="inner">
            
            <header><h1>Using blocks to close transactions</h1></header>
            
            
            <section><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:55:25.717751+00:00</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select current_time&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">12:55:27.385814+00:00</span>
</pre>
<ul class="font-bigger simple">
<li>Commit leaving the block, roll back in case of error</li>
<li>A bit of unnatural usage of <tt class="docutils literal">with</tt> though...</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              29/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-30">
          <div class="inner">
            
            <header><h1>Waiting for psycopg3: explicit transactions</h1></header>
            
            
            <section><ul class="font-bigger simple">
<li><tt class="docutils literal">with conn</tt> closes the connection</li>
<li><tt class="docutils literal">with conn.transaction()</tt> delimits a transaction</li>
<li>It can be nested!</li>
</ul>
<pre><span></span><span class="k">with</span> <span class="n">psycopg3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">CONNINFO</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx1</span><span class="p">:</span>
        <span class="n">num_ok</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx2</span><span class="p">:</span>
                    <span class="n">unreliable_operation</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{operation}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_ok</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">save_number_of_successes</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">num_ok</span><span class="p">)</span>

    <span class="c1"># here the transaction is terminated</span>

<span class="c1"># here the connection is closed</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              30/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-31">
          <div class="inner">
            
            <header><h1>Typecasting</h1></header>
            
            
            <section><img alt="img/pg-to-py.png" src="img/pg-to-py.png" />
<ul class="font-bigger simple">
<li>Converting data from Postgres to Python</li>
<li>Typecasters have:<ol class="arabic">
<li>one or more OID</li>
<li>a name</li>
<li>a conversion function</li>
</ol>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              31/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-32">
          <div class="inner">
            
            <header><h1><tt class="docutils literal">pushdemo.py</tt> architecture</h1></header>
            
            
            <section><img alt="img/pushdemo-diagram.png" src="img/pushdemo-diagram.png" /></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              32/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-33">
          <div class="inner">
            
            <header><h1>Async notification demo</h1></header>
            
            
            <section><p>Using <a class="reference external" href="http://www.gevent.org/">gevent</a>, <a class="reference external" href="http://www.gelens.org/code/gevent-websocket/">gevent-websocket</a>, <a class="reference external" href="https://bitbucket.org/dvarrazzo/psycogreen/">psycogreen</a></p>
<p class="apology">This demo requires the <tt class="docutils literal">pushdemo.py</tt> script running.</p>
<script src="js/jquery.min.js"></script>
<style type="text/css">
      .bar {width: 40px; height: 40px;}
</style>
<script>
    window.onload = function() {
        ws = new WebSocket("ws://localhost:7000/data");
        ws.onopen = function() {
            $('p.apology').hide();
            // drop the offline slide
            $('#target').parents('.slide-wrapper').next().remove();
        }
        ws.onmessage = function(msg) {
            bar = $('#' + msg.data);
            if (bar.length) {
                bar.width(bar.width() + 40);
            } else {
                $('#target').text("DB says: " + msg.data);
            }
        }
    }
</script>
<p id="red" class="bar" style="background-color: red;">&nbsp;</p>
<p id="green" class="bar" style="background-color: green;">&nbsp;</p>
<p id="blue" class="bar" style="background-color: blue;">&nbsp;</p>
<p id="target"></p><p class="text-right">Demo code at <a class="reference external" href="https://github.com/dvarrazzo/psycopg-training-pgconf-2021">https://github.com/dvarrazzo/psycopg-training-pgconf-2021</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              33/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-34">
          <div class="inner">
            
            <header><h1>Async notification demo (offline)</h1></header>
            
            
            <section><img alt="img/pushdemo.png" src="img/pushdemo.png" /></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              34/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-35">
          <div class="inner">
            
            <header><h1>ü§î Questions?</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              35/36
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-36">
          <div class="inner">
            
            <header><h1>ü•∞ Thank you!</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              36/36
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1"><em>psycopg</em>: Python for PostgreSQL</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">What is <tt class="docutils literal">psycopg2</tt>?</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">Have your virtualenv!</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">Basic usage: import</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Zoom: installation</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">Installation for <tt class="docutils literal">psycopg3</tt></a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Basic usage: connection</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Zoom in: connection</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Basic usage: cursor</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">cursor? ü§î</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">No such a thing in psql...</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Basic usage: execute</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">Adaptation</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Adaptation</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">Adaptation</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Adaptation</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Adaptation: only for values</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">Data type mapping</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">More Data!</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">Mythical JSON(B)!</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">Basic usage: fetching results</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">Basic usage: iterating on results</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Waiting for <tt class="docutils literal">psycopg3</tt>: <tt class="docutils literal">conn.execute()</tt></a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Other types of records</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">Server and Client Cursors</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">Running queries: auto-transaction</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Remember to close your transactions!</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">Autocommit mode</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">Using blocks to close transactions</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">Waiting for psycopg3: explicit transactions</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">Typecasting</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32"><tt class="docutils literal">pushdemo.py</tt> architecture</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">Async notification demo</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
      <tr id="toc-row-34">
        <th><a href="#slide34">Async notification demo (offline)</a></th>
        <td><a href="#slide34">34</a></td>
      </tr>
      
      
      <tr id="toc-row-35">
        <th><a href="#slide35">ü§î Questions?</a></th>
        <td><a href="#slide35">35</a></td>
      </tr>
      
      
      <tr id="toc-row-36">
        <th><a href="#slide36">ü•∞ Thank you!</a></th>
        <td><a href="#slide36">36</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Expos√©</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>